<!-- D:\mushroom_web\templates\batch.html -->

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçÑ √áoklu Tahmin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-leaf"></i> Mantar Sƒ±nƒ±flandƒ±rma
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/batch"><i class="fas fa-images"></i> Tahmin</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics"><i class="fas fa-chart-bar"></i> Analiz</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3 fade-in">
                <i class="fas fa-layer-group"></i> Toplu Analiz
            </h1>
            <p class="lead mb-4 fade-in-delay">
                Birden fazla mantar g√∂rselini aynƒ± anda analiz edin
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                
                <!-- Upload Card -->
                <div class="main-card slide-up">
                    <div class="card-header-custom">
                        <h3><i class="fas fa-cloud-upload-alt"></i> √áoklu Dosya Y√ºkle</h3>
                        <p class="mb-0">Birden fazla mantar fotoƒürafƒ± se√ßin (En fazla 10 dosya)</p>
                    </div>

                    {% if error %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle"></i> {{ error }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endif %}

                    <form method="POST" enctype="multipart/form-data" id="batchForm">
                        <div class="upload-area" id="uploadArea">
                            <input type="file" name="files" id="fileInput" accept="image/*" multiple required hidden>
                            <div class="upload-placeholder" id="uploadPlaceholder">
                                <i class="fas fa-images fa-4x mb-3"></i>
                                <h5>Birden Fazla Dosya Se√ßin</h5>
                                <p>veya</p>
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open"></i> Dosyalarƒ± Se√ß
                                </button>
                                <p class="mt-3 text-muted small">PNG, JPG, JPEG - Maksimum 10 dosya</p>
                            </div>
                            <div id="fileListContainer" style="display: none;">
                                <h5 class="mb-3"><i class="fas fa-list"></i> Se√ßilen Dosyalar (<span id="fileCount">0</span>)</h5>
                                <div id="fileList" class="mb-3"></div>
                                <button type="button" class="btn btn-sm btn-danger" onclick="clearFiles()">
                                    <i class="fas fa-times"></i> T√ºm√ºn√º Temizle
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-gradient btn-lg" id="submitBtn">
                                <i class="fas fa-magic"></i> T√ºm√ºn√º Analiz Et
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Results Grid -->
                {% if results %}
                <div class="main-card slide-up-delay mt-4">
                    <div class="card-header-custom">
                        <h3><i class="fas fa-chart-pie"></i> Analiz Sonu√ßlarƒ±</h3>
                        <p class="mb-0">{{ results|length }} adet g√∂rsel analiz edildi</p>
                    </div>

                    <div class="batch-grid">
                        {% for result in results %}
                        <div class="batch-item">
                            <img src="{{ result.image_url }}" alt="Mushroom {{ loop.index }}">
                            <div class="batch-result">
                                <h6 class="mb-2">G√∂rsel {{ loop.index }}</h6>
                                {% if result.pred_label == 'edible' %}
                                    <span class="batch-badge" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                                        <i class="fas fa-check-circle"></i> Yenilebilir
                                    </span>
                                {% else %}
                                    <span class="batch-badge" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white;">
                                        <i class="fas fa-exclamation-triangle"></i> Zehirli
                                    </span>
                                {% endif %}
                                
                                <div class="mt-2 small">
                                    <div class="text-success">
                                        <i class="fas fa-leaf"></i> {{ result.edible_prob }}%
                                    </div>
                                    <div class="text-danger">
                                        <i class="fas fa-skull-crossbones"></i> {{ result.poisonous_prob }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Summary Statistics -->
                    <div class="mt-4 p-4" style="background: #f8f9fa; border-radius: 15px;">
                        <h5 class="mb-3"><i class="fas fa-chart-bar"></i> √ñzet ƒ∞statistikler</h5>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h3 class="text-success">{{ results|selectattr('pred_label', 'equalto', 'edible')|list|length }}</h3>
                                    <p class="mb-0">Yenilebilir</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h3 class="text-danger">{{ results|selectattr('pred_label', 'equalto', 'poisonous')|list|length }}</h3>
                                    <p class="mb-0">Zehirli</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <h3 class="text-primary">{{ results|length }}</h3>
                                    <p class="mb-0">Toplam</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <a href="/batch" class="btn btn-outline-primary">
                            <i class="fas fa-redo"></i> Yeni Toplu Analiz
                        </a>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');

        // Drag & Drop event handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop area when dragging
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('dragover');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('dragover');
            }, false);
        });

        // Handle dropped files
        uploadArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            // Manually set files to input element
            fileInput.files = files;
            handleFiles(files);
        }, false);

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length > 10) {
                alert('Maksimum 10 dosya se√ßebilirsiniz!');
                fileInput.value = '';
                return;
            }

            if (files.length > 0) {
                uploadPlaceholder.style.display = 'none';
                fileListContainer.style.display = 'block';
                fileCount.textContent = files.length;
                
                fileList.innerHTML = '';
                Array.from(files).forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'alert alert-info d-flex align-items-center mb-2';
                    fileItem.innerHTML = `
                        <i class="fas fa-image me-2"></i>
                        <span class="flex-grow-1">${file.name}</span>
                        <small>${(file.size / 1024).toFixed(2)} KB</small>
                    `;
                    fileList.appendChild(fileItem);
                });
            }
        }

        function clearFiles() {
            fileInput.value = '';
            uploadPlaceholder.style.display = 'block';
            fileListContainer.style.display = 'none';
            fileList.innerHTML = '';
        }

        document.getElementById('batchForm').addEventListener('submit', function() {
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analiz ediliyor...';
            document.getElementById('submitBtn').disabled = true;
        });
    </script>
</body>
</html>
